services:
  # ==================== 前端服務 ====================
  front_end:
    build:
      context: ./Front_end
      dockerfile: Dockerfile
    container_name: best-front-end-v1
    ports:
      - "${FRONTEND_PORT:-5556}:5556"
    environment:
      VITE_API_BASE_URL: ${BACKEND_URL:-http://localhost:5555}
      TZ: ${TZ:-Asia/Taipei}
    depends_on:
      - back_end
    networks:
      - best-net-v1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5556"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ==================== 後端服務 ====================
  back_end:
    build:
      context: ./Agent
      dockerfile: Dockerfile
    container_name: best-back-end-v1
    ports:
      - "${BACKEND_PORT:-5555}:5555"
    environment:
      # SQL Server 配置
      MSSQL_HOST: ${MSSQL_HOST:-ms_sql_v1}
      MSSQL_PORT: ${MSSQL_PORT:-1433}
      MSSQL_DB: ${MSSQL_DB:-Chat_Memory_DB}
      MSSQL_USER: ${MSSQL_USER:-sa}
      MSSQL_PASSWORD: ${MSSQL_SA_PASSWORD}
      
      # Ollama 配置
      OLLAMA_API_URL: ${OLLAMA_API_URL}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      
      # RAGFlow 配置
      RAGFLOW_URL: ${RAGFLOW_URL:-http://ragflow:80}
      
      # 系統配置
      TZ: ${TZ:-Asia/Taipei}
    depends_on:
      ms_sql_v1:
        condition: service_healthy
      ragflow:
        condition: service_started
    networks:
      - best-net-v1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ==================== SQL Server 服務 ====================
  ms_sql_v1:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: best-mssql-v1
    ports:
      - "1433:1433"
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Developer"
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      TZ: ${TZ:-Asia/Taipei}
    volumes:
      - mssql_data:/var/opt/mssql
    networks:
      - best-net-v1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P $$MSSQL_SA_PASSWORD -Q \"SELECT 1\" -C || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  # ==================== RAGFlow 服務 ====================
  ragflow:
    image: infiniflow/ragflow:latest
    container_name: best-ragflow-v1
    ports:
      - "${RAGFLOW_PORT:-5557}:80"
    environment:
      TZ: ${TZ:-Asia/Taipei}
      OLLAMA_API_URL: ${OLLAMA_API_URL}
    networks:
      - best-net-v1
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# ==================== 網絡配置 ====================
networks:
  best-net-v1:
    name: best-net-v1
    driver: bridge

# ==================== 數據卷配置 ====================
volumes:
  mssql_data:
    name: best-mssql-data-v1

